import{r as e}from"./react-vendor-DD48japz.js";import{C as t}from"./index-O9bUPr4B.js";import{c as a}from"./candidateUtils-CAE7rsIc.js";const i={emailThreshold:95,phoneThreshold:85,nameThreshold:80,overallThreshold:75,autoMergeThreshold:95,algorithms:{name:"jaro-winkler",phone:"normalized",email:"exact"},enabledFields:["email","phone","name"],realTimeChecking:!0,bulkDetectionEnabled:!0},r=90,n=75,s={email:{exact:"Exact email match: {original} = {matched}",fuzzy:"Similar email: {original} â‰ˆ {matched} ({similarity}% match)"},phone:{exact:"Exact phone match: {original} = {matched}",normalized:"Phone numbers match when normalized: {original} â‰ˆ {matched}",fuzzy:"Similar phone numbers: {original} â‰ˆ {matched} ({similarity}% match)"},name:{exact:"Exact name match: {original} = {matched}",fuzzy:"Similar names: {original} â‰ˆ {matched} ({similarity}% match)",phonetic:"Names sound similar: {original} â‰ˆ {matched} (phonetic match)",jaro_winkler:"Names are very similar: {original} â‰ˆ {matched} ({similarity}% match)"},linkedin:{exact:"Same LinkedIn profile: {original} = {matched}",fuzzy:"Similar LinkedIn profiles: {original} â‰ˆ {matched}"}},l=.4,o=.3,c=.2;class d{static levenshtein(e,t){if(!e||!t)return 0;if(e=e.toLowerCase().trim(),t=t.toLowerCase().trim(),e===t)return 100;const a=Array(t.length+1).fill(null).map(()=>Array(e.length+1).fill(null));for(let n=0;n<=e.length;n++)a[0][n]=n;for(let n=0;n<=t.length;n++)a[n][0]=n;for(let n=1;n<=t.length;n++)for(let i=1;i<=e.length;i++){const r=e[i-1]===t[n-1]?0:1;a[n][i]=Math.min(a[n][i-1]+1,a[n-1][i]+1,a[n-1][i-1]+r)}const i=Math.max(e.length,t.length),r=a[t.length][e.length];return Math.round((i-r)/i*100)}static jaroWinkler(e,t){if(!e||!t)return 0;if((e=e.toLowerCase().trim())===(t=t.toLowerCase().trim()))return 100;const a=e.length,i=t.length;if(0===a||0===i)return 0;const r=Math.floor(Math.max(a,i)/2)-1;if(r<0)return 0;const n=new Array(a).fill(!1),s=new Array(i).fill(!1);let l=0,o=0;for(let u=0;u<a;u++){const a=Math.max(0,u-r),o=Math.min(u+r+1,i);for(let i=a;i<o;i++)if(!s[i]&&e[u]===t[i]){n[u]=!0,s[i]=!0,l++;break}}if(0===l)return 0;let c=0;for(let u=0;u<a;u++)if(n[u]){for(;!s[c];)c++;e[u]!==t[c]&&o++,c++}const d=(l/a+l/i+(l-o/2)/l)/3;let h=0;for(let u=0;u<Math.min(a,i,4)&&e[u]===t[u];u++)h++;return Math.round(100*(d+.1*h*(1-d)))}static soundex(e){if(!e)return"";if(0===(e=e.toUpperCase().replace(/[^A-Z]/g,"")).length)return"";return e=(e[0]+(e=(e=(e=(e=(e=(e=(e=(e=(e=e.substring(1)).replace(/[BFPV]/g,"1")).replace(/[CGJKQSXZ]/g,"2")).replace(/[DT]/g,"3")).replace(/[L]/g,"4")).replace(/[MN]/g,"5")).replace(/[R]/g,"6")).replace(/[AEIOUYHW]/g,"")).replace(/(.)\1+/g,"$1"))+"000").substring(0,4)}static normalizePhone(e){if(!e)return"";const t=e.replace(/\D/g,"");return 10===t.length?t:12===t.length&&t.startsWith("91")?t.substring(2):13===t.length&&t.startsWith("091")?t.substring(3):t}static normalizeEmail(e){return e?e.toLowerCase().trim():""}}const h=new class{constructor(e=i){this.config=e}async detectDuplicates(e,t){const a=Date.now(),i=[];for(const r of t){const t=this.compareCandidate(e,r);t&&t.matchScore>=this.config.overallThreshold&&i.push(t)}i.sort((e,t)=>t.matchScore-e.matchScore);return{hasMatches:i.length>0,matches:i,totalMatches:i.length,highConfidenceMatches:i.filter(e=>"high"===e.confidence).length,mediumConfidenceMatches:i.filter(e=>"medium"===e.confidence).length,lowConfidenceMatches:i.filter(e=>"low"===e.confidence).length,processingTime:Date.now()-a}}compareCandidate(e,t){const a=[];let i=0,s=0;if(this.config.enabledFields.includes("email")&&e.email&&t.email){const r=this.compareEmails(e.email,t.email);r.similarity>=this.config.emailThreshold&&(a.push(r),i+=r.similarity*l,s+=l)}if(this.config.enabledFields.includes("phone")&&e.phone&&t.phone){const r=this.comparePhones(e.phone,t.phone);r.similarity>=this.config.phoneThreshold&&(a.push(r),i+=r.similarity*o,s+=o)}if(this.config.enabledFields.includes("name")&&e.name&&t.name){const r=this.compareNames(e.name,t.name);r.similarity>=this.config.nameThreshold&&(a.push(r),i+=r.similarity*c,s+=c)}if(0===a.length)return null;const d=s>0?Math.round(i/s):0;let h;return h=d>=r?"high":d>=n?"medium":"low",{candidateId:t.id,candidate:t,matchScore:d,matchReasons:a,confidence:h,createdBy:t.createdBy,createdByName:t.createdByName,createdAt:t.createdAt}}compareEmails(e,t){const a=d.normalizeEmail(e),i=d.normalizeEmail(t);let r,n;return a===i?(r=100,n="exact"):(r=d.levenshtein(a,i),n="fuzzy"),{field:"email",similarity:r,algorithm:n,details:this.formatMatchReason("email",n,e,t,r),originalValue:e,matchedValue:t}}comparePhones(e,t){const a=d.normalizePhone(e),i=d.normalizePhone(t);let r,n;return e===t?(r=100,n="exact"):a===i&&a.length>=10?(r=95,n="normalized"):(r=d.levenshtein(a,i),n="fuzzy"),{field:"phone",similarity:r,algorithm:n,details:this.formatMatchReason("phone",n,e,t,r),originalValue:e,matchedValue:t}}compareNames(e,t){let a,i;if(e.toLowerCase().trim()===t.toLowerCase().trim())a=100,i="exact";else{a=d.jaroWinkler(e,t),i="jaro_winkler";const r=d.soundex(e);r===d.soundex(t)&&r.length>0&&a<80&&(a=Math.max(a,75),i="phonetic")}return{field:"name",similarity:a,algorithm:i,details:this.formatMatchReason("name",i,e,t,a),originalValue:e,matchedValue:t}}formatMatchReason(e,t,a,i,r){var n;const l=null==(n=s[e])?void 0:n[t];return l?l.replace("{original}",a).replace("{matched}",i).replace("{similarity}",r.toString()):`${e} match: ${a} â‰ˆ ${i} (${r}% similarity)`}generateMergePreview(e,t){const a=[],i=[],r={...e};return[{key:"name",display:"Name"},{key:"email",display:"Email"},{key:"phone",display:"Phone"},{key:"location",display:"Location"},{key:"currentCompany",display:"Current Company"},{key:"designation",display:"Designation"},{key:"totalExperience",display:"Total Experience"},{key:"lastSalary",display:"Last Salary"},{key:"salaryExpectation",display:"Salary Expectation"},{key:"qualification",display:"Qualification"}].forEach(({key:i,display:n})=>{const s=e[i],l=t[i];s&&l&&s!==l?a.push({field:i,fieldDisplayName:n,primaryValue:s,duplicateValue:l,suggestedValue:s,requiresDecision:!0,conflictType:"different-values"}):!s&&l&&(a.push({field:i,fieldDisplayName:n,primaryValue:null,duplicateValue:l,suggestedValue:l,requiresDecision:!1,conflictType:"missing-data"}),r[i]=l)}),t.notes&&t.notes.length>0&&i.push({type:"note",data:t.notes,originalCandidateId:t.id,preserveInMerged:!0,description:`${t.notes.length} notes from duplicate candidate`}),t.changeHistory&&t.changeHistory.length>0&&i.push({type:"change-history",data:t.changeHistory,originalCandidateId:t.id,preserveInMerged:!0,description:`Change history from duplicate candidate (${t.changeHistory.length} entries)`}),{primaryCandidate:e,duplicateCandidate:t,mergedCandidate:r,conflicts:a,preservedData:i}}applyMergeDecisions(e,t){const a={...e.mergedCandidate};return t.forEach(e=>{a[e.field]=e.selectedValue}),e.preservedData.forEach(e=>{if(e.preserveInMerged)switch(e.type){case"note":a.notes=[...a.notes||[],...e.data];break;case"change-history":a.changeHistory=[...a.changeHistory||[],...e.data]}}),a.updatedAt=new Date,a}updateConfig(e){this.config={...this.config,...e}}getConfig(){return{...this.config}}},u={getConfidenceColor:e=>{switch(e){case"high":return"text-red-600 bg-red-50 border-red-200";case"medium":return"text-amber-600 bg-amber-50 border-amber-200";case"low":return"text-blue-600 bg-blue-50 border-blue-200";default:return"text-gray-600 bg-gray-50 border-gray-200"}},getConfidenceIcon:e=>{switch(e){case"high":return"ðŸ”´";case"medium":return"ðŸŸ¡";case"low":return"ðŸ”µ";default:return"âšª"}},formatMatchScore:e=>`${e}%`,getMatchTypeDisplay:e=>{const t=e.map(e=>e.field);return 1===t.length?t[0].charAt(0).toUpperCase()+t[0].slice(1):`Multiple (${t.join(", ")})`},formatTimeAgo:e=>{const t=(new Date).getTime()-e.getTime(),a=Math.floor(t/864e5);return 0===a?"Today":1===a?"Yesterday":a<7?`${a} days ago`:a<30?`${Math.floor(a/7)} weeks ago`:a<365?`${Math.floor(a/30)} months ago`:`${Math.floor(a/365)} years ago`}},m=()=>{const[i,r]=e.useState(!1),[n,s]=e.useState(null),[l,o]=e.useState([]),[c,d]=e.useState(null),u=e.useCallback(async(e,a=[])=>{r(!0),d(null);try{if(a.length>0){const t=await h.detectDuplicates(e,a);return s(t),t}try{const a=await t.checkDuplicates(e);if(a.success)return s(a.data),a.data}catch(i){}const r=await t.getAll();if(r.success){const t=await h.detectDuplicates(e,r.data);return s(t),t}throw new Error("Failed to check for duplicates")}catch(n){return d(n.message),{hasMatches:!1,matches:[],totalMatches:0}}finally{r(!1)}},[]),m=e.useCallback(async(e,i,n=[])=>{r(!0),d(null);try{const r=h.generateMergePreview(e,i),o=h.applyMergeDecisions(r,n),c=a.createChangeHistoryEntry(e.id,"system","System","merged",[{field:"merged_from",fieldDisplayName:"Merged From",oldValue:null,newValue:i.id,changeDescription:`Merged with candidate ${i.name} (${i.email})`}],`Merged with duplicate candidate ${i.name}`);o.changeHistory=[...o.changeHistory,c];try{const a=await t.merge(e.id,i.id,n);if(a.success)return{success:!0,data:a.data}}catch(s){}if((await t.update(e.id,o)).success){try{await t.delete(i.id)}catch(l){}return{success:!0,data:o}}throw new Error("Failed to merge candidates")}catch(o){return d(o.message),{success:!1,error:o.message}}finally{r(!1)}},[]),g=e.useCallback(async(e={})=>{r(!0),d(null);try{try{const a=await t.getDuplicateGroups(e);if(a.success)return o(a.data),a.data}catch(a){}const i=await t.getAll();if(i.success){const t=await p(i.data,e);return o(t),t}throw new Error("Failed to get duplicate groups")}catch(i){return d(i.message),[]}finally{r(!1)}},[]),p=async(e,t)=>{const a=[],i=new Set;for(let r=0;r<e.length;r++){const t=e[r];if(i.has(t.id))continue;const n=[];for(let a=r+1;a<e.length;a++){const r=e[a];if(i.has(r.id))continue;const s=await h.detectDuplicates(t,[r]);s.hasMatches&&s.matches.length>0&&(n.push(r),i.add(r.id))}if(n.length>0){const e={id:`group_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,candidates:[t,...n],primaryCandidateId:t.id,status:"pending",detectedAt:new Date,resolvedAt:null,resolvedBy:null,resolution:null};a.push(e),i.add(t.id)}}return a},f=e.useCallback(async(e,a)=>{r(!0),d(null);try{try{if((await t.resolveDuplicateGroup(e,a)).success)return o(t=>t.map(t=>t.id===e?{...t,status:"resolved",resolution:a,resolvedAt:new Date}:t)),{success:!0}}catch(i){}return o(t=>t.map(t=>t.id===e?{...t,status:"resolved",resolution:a,resolvedAt:new Date}:t)),{success:!0}}catch(n){return d(n.message),{success:!1,error:n.message}}finally{r(!1)}},[]),y=e.useCallback(async e=>{r(!0),d(null);try{const t={type:"ignore",reason:"Marked as not duplicates",resolvedBy:"current-user",resolvedByName:"Current User",resolvedAt:new Date},a=await f(e,t);return a.success&&o(a=>a.map(a=>a.id===e?{...a,status:"ignored",resolution:t,resolvedAt:new Date}:a)),a}catch(t){return d(t.message),{success:!1,error:t.message}}finally{r(!1)}},[f]),w=e.useCallback(()=>{s(null),d(null)},[]),M=e.useCallback(()=>{d(null)},[]);return{isLoading:i,duplicateResult:n,duplicateGroups:l,error:c,checkDuplicates:u,mergeCandidates:m,getDuplicateGroups:g,resolveDuplicateGroup:f,ignoreDuplicateGroup:y,clearDuplicateResult:w,clearError:M,hasMatches:(null==n?void 0:n.hasMatches)||!1,totalMatches:(null==n?void 0:n.totalMatches)||0,highConfidenceMatches:(null==n?void 0:n.highConfidenceMatches)||0,mediumConfidenceMatches:(null==n?void 0:n.mediumConfidenceMatches)||0,lowConfidenceMatches:(null==n?void 0:n.lowConfidenceMatches)||0}};export{h as a,u as d,m as u};
