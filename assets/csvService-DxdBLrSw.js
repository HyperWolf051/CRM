import{C as e}from"./index-LnfGub8m.js";import{V as t,c as a}from"./csvMappings-CudA6gLI.js";class r{static async importCandidates(t,a,r="registration"){const n={successful:0,failed:0,errors:[],importedCandidates:[]};for(let i=0;i<t.length;i++){const a=t[i],o=a._rowIndex||i+2;try{const{_rowIndex:t,_originalRow:s,_hasErrors:c,...l}=a,d={...l,id:`candidate_${Date.now()}_${i}`,currentStage:this.determineStageFromImportType(r),overallStatus:this.determineStatusFromData(l),createdBy:"csv_import",createdByName:"CSV Import",createdAt:new Date,updatedAt:new Date,changeHistory:[{id:`change_${Date.now()}_${i}`,candidateId:`candidate_${Date.now()}_${i}`,changedBy:"csv_import",changedByName:"CSV Import",changeType:"imported",changes:[{field:"all",fieldDisplayName:"All Fields",oldValue:null,newValue:l,changeDescription:`Candidate imported from CSV (${r})`}],timestamp:new Date,reason:`CSV import - ${r} data`}]},u=this.validateCandidateData(d);if(!u.isValid){n.errors.push({row:o,message:u.errors.join(", "),data:l}),n.failed++;continue}const m=await e.create(d);m.success?(n.successful++,n.importedCandidates.push(m.data)):(n.errors.push({row:o,message:m.message||"Failed to create candidate",data:l}),n.failed++)}catch(s){n.errors.push({row:o,message:s.message||"Unknown error occurred",data:a}),n.failed++}}return n}static determineStageFromImportType(e){return{registration:"registration",resumeShare:"resume-sharing",shortlist:"shortlisting",lineupFeedback:"lineup-feedback",selection:"selection",closure:"closure"}[e]||"registration"}static determineStatusFromData(e){var t,a,r,n,s,i,o;if("Yes"===(null==(t=e.closure)?void 0:t.joiningStatus))return"placed";if("Selected"===(null==(a=e.selection)?void 0:a.selectionStatus))return"selected";if("Rejected"===(null==(r=e.selection)?void 0:r.selectionStatus))return"rejected";if((null==(s=null==(n=e.lineupFeedback)?void 0:n.feedbacks)?void 0:s.length)>0){const t=e.lineupFeedback.feedbacks[e.lineupFeedback.feedbacks.length-1];if("Selected"===t.feedback)return"interviewed";if("Rejected"===t.feedback)return"rejected"}return"Done"===(null==(i=e.shortlisting)?void 0:i.shortlistStatus)?"shortlisted":"Done"===(null==(o=e.resumeSharing)?void 0:o.resumeShareStatus)?"in-process":"new"}static validateCandidateData(e){const a=[];if(["name","email"].forEach(t=>{e[t]&&""!==e[t].toString().trim()||a.push(`${t} is required`)}),e.email&&!t.email.pattern.test(e.email)&&a.push("Invalid email format"),e.phone){const r=t.phone.validate(e.phone);!0!==r&&a.push(r)}return{isValid:0===a.length,errors:a}}static async exportCandidates(e,t){try{const{fields:a,filters:r,exportType:n}=t;let s=[...e];(r.dateRange.start||r.dateRange.end)&&(s=s.filter(e=>{const t=new Date(e.createdAt),a=r.dateRange.start?new Date(r.dateRange.start):null,n=r.dateRange.end?new Date(r.dateRange.end):null;return!(a&&t<a)&&!(n&&t>n)})),"all"!==r.statusFilter&&(s=s.filter(e=>e.overallStatus===r.statusFilter));return{success:!0,data:this.convertCandidatesToCSV(s,a,n),count:s.length}}catch(a){return{success:!1,message:a.message,data:null}}}static convertCandidatesToCSV(e,t,a){const r=t,n=e.map(e=>t.map(t=>{let a=this.getNestedFieldValue(e,t);if(a instanceof Date?a=a.toISOString().split("T")[0]:Array.isArray(a)?a=a.map(e=>"object"==typeof e?JSON.stringify(e):e).join("; "):"object"==typeof a&&null!==a&&(a=JSON.stringify(a)),null==a)return"";const r=String(a);return r.includes(",")||r.includes('"')||r.includes("\n")?`"${r.replace(/"/g,'""')}"`:r}));return[r.join(","),...n.map(e=>e.join(","))].join("\n")}static getNestedFieldValue(e,t){const a=t.split(".");let r=e;for(const n of a){if(null==r)return"";r=r[n]}return r}static async detectDuplicates(t,a=[]){const r=[];if(0===a.length)try{const t=await e.getAll();t.success&&(a=t.data)}catch(n){}return t.forEach((e,t)=>{const n=a.filter(t=>{if(e.email&&t.email&&e.email.toLowerCase()===t.email.toLowerCase())return!0;if(e.phone&&t.phone){const a=e.phone.replace(/\D/g,"");if(a===t.phone.replace(/\D/g,"")&&a.length>=10)return!0}if(e.name&&t.name){if(e.name.toLowerCase().trim()===t.name.toLowerCase().trim())return!0}return!1});n.length>0&&r.push({newCandidateIndex:t,newCandidate:e,matches:n.map(t=>({id:t.id,name:t.name,email:t.email,phone:t.phone,matchReason:this.getDuplicateMatchReason(e,t)}))})}),r}static getDuplicateMatchReason(e,t){const a=[];if(e.email&&t.email&&e.email.toLowerCase()===t.email.toLowerCase()&&a.push("Email match"),e.phone&&t.phone){const r=e.phone.replace(/\D/g,"");r===t.phone.replace(/\D/g,"")&&r.length>=10&&a.push("Phone match")}return e.name&&t.name&&e.name.toLowerCase().trim()===t.name.toLowerCase().trim()&&a.push("Name match"),a.join(", ")}static generateCSVTemplate(e){const t=a.CSV_FIELD_MAPPINGS[e];if(!t)throw new Error(`Unknown import type: ${e}`);const r=Object.keys(t),n=r.map(e=>{switch(e){case"DATE":return"4-08-2025";case"CV No":return"CV001";case"NAME":return"John Doe";case"PHONE":return"+91 9876543210";case"EMAIL":return"john.doe@email.com";case"LOC.(City,State)":return"Mumbai, Maharashtra";case"INTERSTED FOR":return"Software Developer";case"DESIGNATION":return"Senior Developer";case"TOTAL EXP IN YEARS":return"5 years";case"LAST SALARY":return"8K";case"SALARY EXP.":return"12K";case"QUALIFICATION":return"B.Tech";case"REGISTRATION":return"Yes";case"REG.AMT":return"1000";case"ALLOCATION":return"Sheet-1";default:return"Sample Data"}});return[r.join(","),n.join(",")].join("\n")}}export{r as C};
